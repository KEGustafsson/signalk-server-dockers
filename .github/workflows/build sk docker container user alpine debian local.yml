name: SignalK Docker Build - User Local (Ubuntu + Alpine + Debian)

on:
  workflow_dispatch:
    inputs:
      build_docker_tags_ubuntu:
        description: 'Build Ubuntu docker image'
        type: boolean
        default: true
      build_docker_tags_alpine:
        description: 'Build Alpine docker image'
        type: boolean
        default: true
      build_docker_tags_debian:
        description: 'Build Debian docker image'
        type: boolean
        default: true

jobs:
  specification:
    name: Specification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Node setup
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
      - name: specification
        run: |
          git clone https://github.com/SignalK/specification.git
          cd specification
          npm i
          npm pack
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: specification
          path: |
            ./specification/*.tgz

  nmea0183-signalk:
    name: nmea0183 Signal K
    needs: [specification]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Node setup
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
      - uses: actions/download-artifact@v7
        with:
          name: specification
      - name: nmea0183-signalk
        run: |
          git clone https://github.com/SignalK/nmea0183-signalk.git
          cd nmea0183-signalk
          mv ../*.tgz .
          npm i --save *.tgz
          rm -rf node_modules
          rm -f package-lock.json
          rm -f *.tgz
          npm pack
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: nmea0183-signalk
          path: |
            ./nmea0183-signalk/*.tgz

  signalk-server:
    name: SignalK Server build
    needs: [nmea0183-signalk]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Node setup
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
      - name: signalk-server tags
        id: tags
        run: |
          git clone https://github.com/SignalK/signalk-server.git
          cd signalk-server
          git fetch --tags
          tag=$(git describe --tags `git rev-list --tags --max-count=1`)
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "Extracted tag: $tag"
          cd ..
          rm -rf signalk-server
      - name: signalk-server download and patch
        id: git
        run: |
          git clone https://github.com/SignalK/signalk-server.git
          cd signalk-server
          applied=false
          for dir in ./../patch_latest_2/[0-9]*/; do
            if [ -d "$dir" ] && ls "$dir"*.patch 1>/dev/null 2>&1; then
              echo "Applying patches from $(basename "$dir")"
              git apply "$dir"*.patch
              applied=true
            fi
          done
          if [ "$applied" = false ]; then echo "No patches to apply"; fi
      - uses: actions/download-artifact@v7
        with:
          name: nmea0183-signalk
      - uses: actions/download-artifact@v7
        with:
          name: specification
      - name: signalk-server build
        run: |
          cd signalk-server
          mv ./../*.tgz .
          rm -f package-lock.json
          rm -rf node_modules
          npm cache clean -f
          npm install npm@latest -g
          npm install --package-lock-only
          npm ci && npm cache clean --force
          npm run build:all
          npm pack --workspaces
          rm signalk-typedoc-signalk-theme*.tgz
          npm pack
      - name: Save tag to artifact
        run: echo ${{ steps.tags.outputs.tag }} > tag.txt
      - name: Upload tag
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: tag
          path: tag.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: packed-modules
          path: ./signalk-server/*.tgz

  build_docker_tags_ubuntu:
    name: Ubuntu tags
    if: ${{ github.event.inputs.build_docker_tags_ubuntu == 'true' }}
    needs: [signalk-server]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [24.04]
        node: [22.x, 24.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: tag
      - name: Set TAG for build-args
        id: vars
        run: |
          tag=$(cat tag.txt)
          echo "Extracted tag: $tag"
          echo "TAG=$tag" >> $GITHUB_OUTPUT
          IFS='.' read -r MAJOR MINOR PATCH <<< "$tag"
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MAJOR.$MINOR" >> $GITHUB_OUTPUT
          echo "ghcr=ghcr.io/kegustafsson/signalk-server" >> $GITHUB_OUTPUT
          echo "hub=kgustafs/signalk-server" >> $GITHUB_OUTPUT
      - name: Set tags
        id: set-tags
        run: |
          if [[ "${{ steps.vars.outputs.tag }}" == *beta* ]]; then
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.TAG }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:latest-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.TAG }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:latest-${{ matrix.node }}"
          else
            tags="${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.TAG }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.MAJOR }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.MINOR }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:latest-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.TAG }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.MAJOR }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.MINOR }}-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:latest-${{ matrix.node }}"
          fi
          echo "tags=$tags" >> $GITHUB_OUTPUT
      - name: Save docker tags to artifact
        run: echo ${{ steps.set-tags.outputs.tags }} > docker_tags_${{ matrix.os }}_${{ matrix.node }}.txt
      - name: Upload tag
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: docker_tags_${{ matrix.os }}_${{ matrix.node }}
          path: docker_tags_${{ matrix.os }}_${{ matrix.node }}.txt

  build-images:
    name: Build Ubuntu image
    needs: [build_docker_tags_ubuntu]
    strategy:
      matrix:
        os: [24.04]
        node: [22.x, 24.x]
        vm: [ubuntu-latest, ubuntu-24.04-arm]
        include:
          - vm: ubuntu-latest
            os: 24.04
            arch: amd
            platform: linux/amd64
          - vm: ubuntu-24.04-arm
            os: 24.04
            arch: arm
            node: 22.x
            platform: linux/arm64,linux/arm/v7
          - vm: ubuntu-24.04-arm
            os: 24.04
            arch: arm
            node: 24.x
            platform: linux/arm64
    runs-on: ${{ matrix.vm }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: packed-modules
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile_user
          platforms: ${{ matrix.platform }}
          push: false
          outputs: type=oci,dest=/tmp/image-${{ matrix.arch }}-${{ matrix.os }}-${{ matrix.node }}.tar
          tags: signalk-server:${{ matrix.arch }}-${{ matrix.os }}-${{ matrix.node }}
          build-args: |
            BASE_IMAGE=${{ matrix.os }}-${{ matrix.node }}
      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: image-${{ matrix.arch }}-${{ matrix.os }}-${{ matrix.node }}
          path: /tmp/image-${{ matrix.arch }}-${{ matrix.os }}-${{ matrix.node }}.tar
          retention-days: 1

  create-and-push-manifest:
    name: Ubuntu manifest
    needs: [build-images]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [24.04]
        node: [22.x, 24.x]
        include:
          - os: 24.04
            node: 24.x
            tag: latest
          - os: 24.04
            node: 22.x
            tag: latest-22.x
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Download Docker tag artifact
        uses: actions/download-artifact@v7
        with:
          name: docker_tags_${{ matrix.os }}_${{ matrix.node }}
      - name: Download AMD image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-amd-${{ matrix.os }}-${{ matrix.node }}
      - name: Download ARM image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-arm-${{ matrix.os }}-${{ matrix.node }}
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Load Docker images from OCI tarballs
        run: |
          skopeo copy --multi-arch=all oci-archive:image-amd-${{ matrix.os }}-${{ matrix.node }}.tar \
            docker-daemon:signalk-server:amd-${{ matrix.os }}-${{ matrix.node }}
          skopeo copy --multi-arch=all oci-archive:image-arm-${{ matrix.os }}-${{ matrix.node }}.tar \
            docker-daemon:signalk-server:arm-${{ matrix.os }}-${{ matrix.node }}
      - name: Normalize and filter GHCR tags (multiline output)
        id: ghcr_tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'IMAGES<<EOF'
            sed 's/,/\n/g' docker_tags_${{ matrix.os }}_${{ matrix.node }}.txt \
              | grep '^ghcr\.io/'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}
      - name: Tag and push images to GHCR
        run: |
          docker tag signalk-server:amd-${{ matrix.os }}-${{ matrix.node }} \
            ghcr.io/kegustafsson/signalk-server:amd-${{ matrix.os }}-${{ matrix.node }}
          docker push ghcr.io/kegustafsson/signalk-server:amd-${{ matrix.os }}-${{ matrix.node }}
          
          docker tag signalk-server:arm-${{ matrix.os }}-${{ matrix.node }} \
            ghcr.io/kegustafsson/signalk-server:arm-${{ matrix.os }}-${{ matrix.node }}
          docker push ghcr.io/kegustafsson/signalk-server:arm-${{ matrix.os }}-${{ matrix.node }}
      - name: Create and push multi-arch manifest to GHCR
        uses: int128/docker-manifest-create-action@v2
        with:
          tags: |
            ${{ steps.ghcr_tags.outputs.IMAGES }}
            ghcr.io/kegustafsson/signalk-server:${{ matrix.tag }}
          sources: |
            ghcr.io/kegustafsson/signalk-server:amd-${{ matrix.os }}-${{ matrix.node }}
            ghcr.io/kegustafsson/signalk-server:arm-${{ matrix.os }}-${{ matrix.node }}

  copy-to-dockerhub:
    name: Ubuntu copy to Docker Hub
    needs: create-and-push-manifest
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [24.04]
        node: [22.x, 24.x]
        include:
          - os: 24.04
            node: 24.x
            tag: latest
          - os: 24.04
            node: 22.x
            tag: latest-22.x
    steps:
      - name: Download Docker tag artifact
        uses: actions/download-artifact@v7
        with:
          name: docker_tags_${{ matrix.os }}_${{ matrix.node }}
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Normalize and filter GHCR tags
        shell: bash
        run: |
          set -euo pipefail
          sed 's/,/\n/g' docker_tags_${{ matrix.os }}_${{ matrix.node }}.txt \
            | grep '^ghcr\.io/' \
            > tags.txt
      - name: Copy images from GHCR to Docker Hub
        shell: bash
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          while IFS= read -r ghcr_image; do
            [ -z "$ghcr_image" ] && continue
            hub_image="${ghcr_image/ghcr.io\/kegustafsson\/signalk-server/docker.io\/kgustafs\/signalk-server}"
            skopeo copy --all \
              --src-creds "${GHCR_USERNAME}:${GHCR_TOKEN}" \
              --dest-creds "${DOCKER_HUB_USERNAME}:${DOCKER_HUB_ACCESS_TOKEN}" \
              "docker://${ghcr_image}" \
              "docker://${hub_image}"
          done < tags.txt
          skopeo copy --all \
            --src-creds "${GHCR_USERNAME}:${GHCR_TOKEN}" \
            --dest-creds "${DOCKER_HUB_USERNAME}:${DOCKER_HUB_ACCESS_TOKEN}" \
            "docker://ghcr.io/kegustafsson/signalk-server:${{ matrix.tag }}" \
            "docker://docker.io/kgustafs/signalk-server:${{ matrix.tag }}"

  build_docker_tags_alpine:
    name: Alpine tags
    if: ${{ github.event.inputs.build_docker_tags_alpine == 'true' }}
    needs: [signalk-server]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [22, 24]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: tag
      - name: Set TAG for build-args
        id: vars
        run: |
          tag=$(cat tag.txt)
          echo "Extracted tag: $tag"
          echo "TAG=$tag" >> $GITHUB_OUTPUT
          IFS='.' read -r MAJOR MINOR PATCH <<< "$tag"
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MAJOR.$MINOR" >> $GITHUB_OUTPUT
          echo "ghcr=ghcr.io/kegustafsson/signalk-server" >> $GITHUB_OUTPUT
          echo "hub=kgustafs/signalk-server" >> $GITHUB_OUTPUT
      - name: Set tags
        id: set-tags
        run: |
          if [[ "${{ steps.vars.outputs.tag }}" == *beta* ]]; then
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.TAG }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:latest-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.TAG }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:latest-alpine-${{ matrix.node }}"
          else
            tags="${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.TAG }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.MAJOR }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.MINOR }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:latest-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.TAG }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.MAJOR }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.MINOR }}-alpine-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:latest-alpine-${{ matrix.node }}"
          fi
          echo "tags=$tags" >> $GITHUB_OUTPUT
      - name: Save docker tags to artifact
        run: echo ${{ steps.set-tags.outputs.tags }} > docker_tags_alpine_${{ matrix.node }}.txt
      - name: Upload tag
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: docker_tags_alpine_${{ matrix.node }}
          path: docker_tags_alpine_${{ matrix.node }}.txt

  build-alpine-images:
    name: Build Alpine image
    needs: [build_docker_tags_alpine]
    strategy:
      matrix:
        node: [22, 24]
        vm: [ubuntu-latest, ubuntu-24.04-arm]
        include:
          - vm: ubuntu-latest
            node: 24
            arch: amd
            platform: linux/amd64
          - vm: ubuntu-latest
            node: 22
            arch: amd
            platform: linux/amd64
          - vm: ubuntu-24.04-arm
            arch: arm
            node: 22
            platform: linux/arm64,linux/arm/v7
          - vm: ubuntu-24.04-arm
            arch: arm
            node: 24
            platform: linux/arm64
    runs-on: ${{ matrix.vm }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: packed-modules
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile_user
          platforms: ${{ matrix.platform }}
          push: false
          outputs: type=oci,dest=/tmp/image-${{ matrix.arch }}-alpine-${{ matrix.node }}.tar
          tags: signalk-server:${{ matrix.arch }}-alpine-${{ matrix.node }}
          build-args: |
            BASE_IMAGE=alpine-${{ matrix.node }}
      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: image-${{ matrix.arch }}-alpine-${{ matrix.node }}
          path: /tmp/image-${{ matrix.arch }}-alpine-${{ matrix.node }}.tar
          retention-days: 1

  create-and-push-alpine-manifest:
    name: Alpine manifest
    needs: [build-alpine-images]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [22, 24]
        include:
          - node: 24
            tag: latest-alpine
          - node: 22
            tag: latest-alpine-22
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Download Docker tag artifact
        uses: actions/download-artifact@v7
        with:
          name: docker_tags_alpine_${{ matrix.node }}
      - name: Download AMD image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-amd-alpine-${{ matrix.node }}
      - name: Download ARM image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-arm-alpine-${{ matrix.node }}
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Load Docker images from OCI tarballs
        run: |
          skopeo copy --multi-arch=all oci-archive:image-amd-alpine-${{ matrix.node }}.tar \
            docker-daemon:signalk-server:amd-alpine-${{ matrix.node }}
          skopeo copy --multi-arch=all oci-archive:image-arm-alpine-${{ matrix.node }}.tar \
            docker-daemon:signalk-server:arm-alpine-${{ matrix.node }}
      - name: Normalize and filter GHCR tags (multiline output)
        id: ghcr_tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'IMAGES<<EOF'
            sed 's/,/\n/g' docker_tags_alpine_${{ matrix.node }}.txt \
              | grep '^ghcr\.io/'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}
      - name: Tag and push images to GHCR
        run: |
          docker tag signalk-server:amd-alpine-${{ matrix.node }} \
            ghcr.io/kegustafsson/signalk-server:amd-alpine-${{ matrix.node }}
          docker push ghcr.io/kegustafsson/signalk-server:amd-alpine-${{ matrix.node }}
          
          docker tag signalk-server:arm-alpine-${{ matrix.node }} \
            ghcr.io/kegustafsson/signalk-server:arm-alpine-${{ matrix.node }}
          docker push ghcr.io/kegustafsson/signalk-server:arm-alpine-${{ matrix.node }}
      - name: Create and push multi-arch manifest to GHCR
        uses: int128/docker-manifest-create-action@v2
        with:
          tags: |
            ${{ steps.ghcr_tags.outputs.IMAGES }}
            ghcr.io/kegustafsson/signalk-server:${{ matrix.tag }}
          sources: |
            ghcr.io/kegustafsson/signalk-server:amd-alpine-${{ matrix.node }}
            ghcr.io/kegustafsson/signalk-server:arm-alpine-${{ matrix.node }}

  copy-alpine-to-dockerhub:
    name: Alpine copy to Docker Hub
    needs: create-and-push-alpine-manifest
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [22, 24]
        include:
          - node: 24
            tag: latest-alpine
          - node: 22
            tag: latest-alpine-22
    steps:
      - name: Download Docker tag artifact
        uses: actions/download-artifact@v7
        with:
          name: docker_tags_alpine_${{ matrix.node }}
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Normalize and filter GHCR tags
        shell: bash
        run: |
          set -euo pipefail
          sed 's/,/\n/g' docker_tags_alpine_${{ matrix.node }}.txt \
            | grep '^ghcr\.io/' \
            > tags.txt
      - name: Copy images from GHCR to Docker Hub
        shell: bash
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          while IFS= read -r ghcr_image; do
            [ -z "$ghcr_image" ] && continue
            hub_image="${ghcr_image/ghcr.io\/kegustafsson\/signalk-server/docker.io\/kgustafs\/signalk-server}"
            skopeo copy --all \
              --src-creds "${GHCR_USERNAME}:${GHCR_TOKEN}" \
              --dest-creds "${DOCKER_HUB_USERNAME}:${DOCKER_HUB_ACCESS_TOKEN}" \
              "docker://${ghcr_image}" \
              "docker://${hub_image}"
          done < tags.txt
          skopeo copy --all \
            --src-creds "${GHCR_USERNAME}:${GHCR_TOKEN}" \
            --dest-creds "${DOCKER_HUB_USERNAME}:${DOCKER_HUB_ACCESS_TOKEN}" \
            "docker://ghcr.io/kegustafsson/signalk-server:${{ matrix.tag }}" \
            "docker://docker.io/kgustafs/signalk-server:${{ matrix.tag }}"

  build_docker_tags_debian:
    name: Debian tags
    if: ${{ github.event.inputs.build_docker_tags_debian == 'true' }}
    needs: [signalk-server]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [22, 24]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: tag
      - name: Set TAG for build-args
        id: vars
        run: |
          tag=$(cat tag.txt)
          echo "Extracted tag: $tag"
          echo "TAG=$tag" >> $GITHUB_OUTPUT
          IFS='.' read -r MAJOR MINOR PATCH <<< "$tag"
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MAJOR.$MINOR" >> $GITHUB_OUTPUT
          echo "ghcr=ghcr.io/kegustafsson/signalk-server" >> $GITHUB_OUTPUT
          echo "hub=kgustafs/signalk-server" >> $GITHUB_OUTPUT
      - name: Set tags
        id: set-tags
        run: |
          if [[ "${{ steps.vars.outputs.tag }}" == *beta* ]]; then
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.TAG }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:latest-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.TAG }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:latest-debian-${{ matrix.node }}"
          else
            tags="${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.TAG }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.MAJOR }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:${{ steps.vars.outputs.MINOR }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.ghcr }}:latest-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.TAG }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.MAJOR }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:${{ steps.vars.outputs.MINOR }}-debian-${{ matrix.node }}"
            tags="$tags,${{ steps.vars.outputs.hub }}:latest-debian-${{ matrix.node }}"
          fi
          echo "tags=$tags" >> $GITHUB_OUTPUT
      - name: Save docker tags to artifact
        run: echo ${{ steps.set-tags.outputs.tags }} > docker_tags_debian_${{ matrix.node }}.txt
      - name: Upload tag
        uses: actions/upload-artifact@v6
        with:
          retention-days: 1
          name: docker_tags_debian_${{ matrix.node }}
          path: docker_tags_debian_${{ matrix.node }}.txt

  build-debian-images:
    name: Build Debian image
    needs: [build_docker_tags_debian]
    strategy:
      matrix:
        node: [22, 24]
        vm: [ubuntu-latest, ubuntu-24.04-arm]
        include:
          - vm: ubuntu-latest
            node: 24
            arch: amd
            platform: linux/amd64
          - vm: ubuntu-latest
            node: 22
            arch: amd
            platform: linux/amd64
          - vm: ubuntu-24.04-arm
            arch: arm
            node: 22
            platform: linux/arm64,linux/arm/v7
          - vm: ubuntu-24.04-arm
            arch: arm
            node: 24
            platform: linux/arm64
    runs-on: ${{ matrix.vm }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          name: packed-modules
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile_user
          platforms: ${{ matrix.platform }}
          push: false
          outputs: type=oci,dest=/tmp/image-${{ matrix.arch }}-debian-${{ matrix.node }}.tar
          tags: signalk-server:${{ matrix.arch }}-debian-${{ matrix.node }}
          build-args: |
            BASE_IMAGE=debian-${{ matrix.node }}
      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: image-${{ matrix.arch }}-debian-${{ matrix.node }}
          path: /tmp/image-${{ matrix.arch }}-debian-${{ matrix.node }}.tar
          retention-days: 1

  create-and-push-debian-manifest:
    name: Debian manifest
    needs: [build-debian-images]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [22, 24]
        include:
          - node: 24
            tag: latest-debian
          - node: 22
            tag: latest-debian-22
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Download Docker tag artifact
        uses: actions/download-artifact@v7
        with:
          name: docker_tags_debian_${{ matrix.node }}
      - name: Download AMD image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-amd-debian-${{ matrix.node }}
      - name: Download ARM image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-arm-debian-${{ matrix.node }}
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Load Docker images from OCI tarballs
        run: |
          skopeo copy --multi-arch=all oci-archive:image-amd-debian-${{ matrix.node }}.tar \
            docker-daemon:signalk-server:amd-debian-${{ matrix.node }}
          skopeo copy --multi-arch=all oci-archive:image-arm-debian-${{ matrix.node }}.tar \
            docker-daemon:signalk-server:arm-debian-${{ matrix.node }}
      - name: Normalize and filter GHCR tags (multiline output)
        id: ghcr_tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'IMAGES<<EOF'
            sed 's/,/\n/g' docker_tags_debian_${{ matrix.node }}.txt \
              | grep '^ghcr\.io/'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}
      - name: Tag and push images to GHCR
        run: |
          docker tag signalk-server:amd-debian-${{ matrix.node }} \
            ghcr.io/kegustafsson/signalk-server:amd-debian-${{ matrix.node }}
          docker push ghcr.io/kegustafsson/signalk-server:amd-debian-${{ matrix.node }}
          
          docker tag signalk-server:arm-debian-${{ matrix.node }} \
            ghcr.io/kegustafsson/signalk-server:arm-debian-${{ matrix.node }}
          docker push ghcr.io/kegustafsson/signalk-server:arm-debian-${{ matrix.node }}
      - name: Create and push multi-arch manifest to GHCR
        uses: int128/docker-manifest-create-action@v2
        with:
          tags: |
            ${{ steps.ghcr_tags.outputs.IMAGES }}
            ghcr.io/kegustafsson/signalk-server:${{ matrix.tag }}
          sources: |
            ghcr.io/kegustafsson/signalk-server:amd-debian-${{ matrix.node }}
            ghcr.io/kegustafsson/signalk-server:arm-debian-${{ matrix.node }}

  copy-debian-to-dockerhub:
    name: Debian copy to Docker Hub
    needs: create-and-push-debian-manifest
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [22, 24]
        include:
          - node: 24
            tag: latest-debian
          - node: 22
            tag: latest-debian-22
    steps:
      - name: Download Docker tag artifact
        uses: actions/download-artifact@v7
        with:
          name: docker_tags_debian_${{ matrix.node }}
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Normalize and filter GHCR tags
        shell: bash
        run: |
          set -euo pipefail
          sed 's/,/\n/g' docker_tags_debian_${{ matrix.node }}.txt \
            | grep '^ghcr\.io/' \
            > tags.txt
      - name: Copy images from GHCR to Docker Hub
        shell: bash
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          while IFS= read -r ghcr_image; do
            [ -z "$ghcr_image" ] && continue
            hub_image="${ghcr_image/ghcr.io\/kegustafsson\/signalk-server/docker.io\/kgustafs\/signalk-server}"
            skopeo copy --all \
              --src-creds "${GHCR_USERNAME}:${GHCR_TOKEN}" \
              --dest-creds "${DOCKER_HUB_USERNAME}:${DOCKER_HUB_ACCESS_TOKEN}" \
              "docker://${ghcr_image}" \
              "docker://${hub_image}"
          done < tags.txt
          skopeo copy --all \
            --src-creds "${GHCR_USERNAME}:${GHCR_TOKEN}" \
            --dest-creds "${DOCKER_HUB_USERNAME}:${DOCKER_HUB_ACCESS_TOKEN}" \
            "docker://ghcr.io/kegustafsson/signalk-server:${{ matrix.tag }}" \
            "docker://docker.io/kgustafs/signalk-server:${{ matrix.tag }}"

  housekeeping:
    name: Housekeeping
    if: |
      always() &&
      (needs.copy-to-dockerhub.result == 'success' || needs.copy-to-dockerhub.result == 'skipped') &&
      (needs.copy-alpine-to-dockerhub.result == 'success' || needs.copy-alpine-to-dockerhub.result == 'skipped') &&
      (needs.copy-debian-to-dockerhub.result == 'success' || needs.copy-debian-to-dockerhub.result == 'skipped') &&
      (needs.copy-to-dockerhub.result == 'success' || 
       needs.copy-alpine-to-dockerhub.result == 'success' || 
       needs.copy-debian-to-dockerhub.result == 'success')
    needs: [copy-to-dockerhub, copy-alpine-to-dockerhub, copy-debian-to-dockerhub]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Remove intermediate Docker Images from GHCR
        uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          packages: signalk-server
          delete-untagged: true
          delete-tags: |
            amd-*
            arm-*
          token: ${{ secrets.GHCR_TOKEN_NEW }}

  slack:
    name: Slack update
    if: always()
    runs-on: ubuntu-latest
    needs: housekeeping
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: tag
      - name: Set TAG for build-args
        id: vars
        run: |
          tag=$(cat tag.txt)
          echo "Extracted tag: $tag"
          echo "TAG=$tag" >> $GITHUB_OUTPUT
      - name: Slack notification
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"Manually triggered Ubuntu + Alpine + Debian images ready, ${{ steps.vars.outputs.TAG }}"}' https://hooks.slack.com/services/${{ secrets.SLACK }}
