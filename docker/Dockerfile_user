ARG BASE_IMAGE
FROM ghcr.io/kegustafsson/signalk-server-base:latest-${BASE_IMAGE} AS base

USER node
WORKDIR /home/node/signalk

RUN mkdir -p /home/node/.signalk/ /home/node/signalk/ \
  && npm config rm proxy \
  && npm config rm https-proxy \
  && npm config set fetch-retries 5 \
  && npm config set fetch-retry-mintimeout 60000 \
  && npm config set fetch-retry-maxtimeout 120000 \
  && npm cache clean -f

FROM base AS tarballs_installed
COPY --chown=node:node *.tgz .

RUN set -x; \
    npm init -y && \
    SERVER_TARBALL=$(ls signalk-server-*.tgz | head -n 1) && \
    echo "Found Server: $SERVER_TARBALL" && \
    EXTRAS=$(ls *.tgz | grep -v "$SERVER_TARBALL" || true) && \
    echo "Found Extras: $EXTRAS" && \
    if [ -n "$EXTRAS" ]; then npm install $EXTRAS; fi && \
    npm install "$SERVER_TARBALL" --install-strategy=nested && \
    if [ -d node_modules/@signalk ]; then \
        dest="node_modules/signalk-server/node_modules" && \
        mkdir -p "$dest/@signalk" && \
        cp -rf node_modules/@signalk/* "$dest/@signalk/" && \
        mkdir -p "$dest/@mxtommy" && \
        if [ -d node_modules/@mxtommy/kip ]; then cp -rf node_modules/@mxtommy/kip "$dest/@mxtommy/"; fi; \
    fi && \
    npm cache clean --force && \
    rm *.tgz

FROM base
USER node

COPY --from=tarballs_installed --chown=node:node /home/node/ /home/node/
COPY --chown=node:node --chmod=755 docker/startup.sh startup.sh

ENV IS_IN_DOCKER=true
ENV SKIP_ADMINUI_VERSION_CHECK=true
WORKDIR /home/node/.signalk
USER node
EXPOSE 3000
ENTRYPOINT ["/home/node/signalk/startup.sh"]
