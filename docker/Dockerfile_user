ARG BASE_IMAGE
FROM ghcr.io/kegustafsson/signalk-server-base:latest-${BASE_IMAGE} AS base

USER node
WORKDIR /home/node/signalk

RUN mkdir -p /home/node/.signalk/ /home/node/signalk/ \
  && npm config rm proxy \
  && npm config rm https-proxy \
  && npm config set fetch-retries 5 \
  && npm config set fetch-retry-mintimeout 60000 \
  && npm config set fetch-retry-maxtimeout 120000 \
  && npm cache clean -f

FROM base AS tarballs_installed
COPY --chown=node:node *.tgz .

# Install signalk-server nested, then all other tarballs hoisted in a single npm install,
# and finally copy @signalk packages into the nested node_modules
RUN npm init -y \
  && workspace_tarballs=$(ls *.tgz 2>/dev/null | grep -v '^signalk-server-[0-9]' || true) \
  && if [ -n "$workspace_tarballs" ]; then npm install $workspace_tarballs; fi \
  && server_tarball=$(ls signalk-server-[0-9]*.tgz) \
  && npm install "$server_tarball" --install-strategy=nested \
  && if [ -d node_modules/@signalk ]; then \
       mkdir -p node_modules/signalk-server/node_modules/@signalk/ \
       && cp -rf node_modules/@signalk/* node_modules/signalk-server/node_modules/@signalk/ \
       && rm -rf node_modules/@signalk/ \
       && mkdir -p node_modules/signalk-server/node_modules/@mxtommy/ \
       && cp -rf node_modules/@mxtommy/kip node_modules/signalk-server/node_modules/@mxtommy/ \
       && rm -rf node_modules/@mxtommy/;
     fi

FROM base
USER node

COPY --from=tarballs_installed --chown=node:node /home/node/ /home/node/
COPY --chown=node:node --chmod=755 docker/startup.sh startup.sh

ENV IS_IN_DOCKER=true
ENV SKIP_ADMINUI_VERSION_CHECK=true
WORKDIR /home/node/.signalk
USER node
EXPOSE 3000
ENTRYPOINT ["/home/node/signalk/startup.sh"]
