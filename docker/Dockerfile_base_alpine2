# Signal K Server - Minimal Alpine-based Image (Experimental)
#
# A minimal image based on Alpine Linux.
# Features:
#   - Small image size (~150MB vs ~800MB Ubuntu)
#   - Node.js 24 with Python for native module builds
#   - SocketCAN and D-Bus support
#   - mDNS via avahi-compat-libdns_sd
#
# Usage:
#   ./scripts/build-local.sh --alpine --branch fix_avahi
#
# Note: This is experimental and for Linux arm64/amd64 only

ARG NODE_VERSION=24

# Build stage - compile native modules
FROM node:${NODE_VERSION}-alpine AS builder

# Install build dependencies
RUN apk add --no-cache \
    python3 \
    py3-pip \
    make \
    g++ \
    linux-headers \
    dbus-dev \
    avahi-dev \
    glib-dev

# Create node user directories (node user already exists in official image)
USER node
WORKDIR /home/node/signalk

# Copy and install tarballs
COPY --chown=node:node *.tgz ./
RUN npm config set fetch-retries 5 && \
    npm config set fetch-retry-mintimeout 60000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm install ./*.tgz && \
    mkdir -p node_modules/signalk-server/node_modules && \
    cp -r node_modules/@signalk node_modules/signalk-server/node_modules/ && \
    npm cache clean --force

# Final minimal runtime image
FROM node:${NODE_VERSION}-alpine

# Install runtime dependencies only (minimal)
RUN apk add --no-cache \
    python3 \
    bash \
    dbus \
    dbus-libs \
    avahi \
    avahi-compat-libdns_sd \
    glib \
    libcap \
    procps \
    iproute2 \
    can-utils \
    && rm -rf /var/cache/apk/*

# Add groups for hardware access (node user already exists with UID 1000)
RUN addgroup -g 20 dialout 2>/dev/null || true && \
    addgroup -g 990 i2c 2>/dev/null || true && \
    addgroup -g 989 spi 2>/dev/null || true && \
    addgroup node dialout 2>/dev/null || true && \
    addgroup node i2c 2>/dev/null || true && \
    addgroup node spi 2>/dev/null || true

# Allow setting time without sudo (for NTP plugins)
RUN chmod u+s /usr/bin/date 2>/dev/null || true

# Setup D-Bus directories
RUN mkdir -p /var/run/dbus && \
    chmod 755 /var/run/dbus && \
    mkdir -p /var/run/avahi-daemon && \
    chmod 755 /var/run/avahi-daemon

# Copy D-Bus configuration
COPY avahi/avahi-dbus.conf /etc/dbus-1/system.d/avahi-dbus.conf
COPY bluez/bluezuser.conf /etc/dbus-1/system.d/bluezuser.conf

# Copy built application from builder
COPY --from=builder --chown=node:node /home/node/signalk /home/node/signalk

# Create data directory
RUN mkdir -p /home/node/.signalk && chown node:node /home/node/.signalk

# Copy startup script
COPY --chown=node:node startup.sh /home/node/signalk/startup.sh
RUN chmod +x /home/node/signalk/startup.sh

USER node
WORKDIR /home/node/.signalk

EXPOSE 3000

ENV IS_IN_DOCKER=true
ENV SKIP_ADMINUI_VERSION_CHECK=true

ENTRYPOINT ["/home/node/signalk/startup.sh"]
