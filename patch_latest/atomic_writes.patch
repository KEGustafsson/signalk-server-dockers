From af1295c3e1f55876685a8ba9a56fa6576e844638 Mon Sep 17 00:00:00 2001
From: KE Gustafsson <ke.gustafsson@gmail.com>
Date: Mon, 5 Jan 2026 19:53:06 +0200
Subject: [PATCH] fix: use atomic writes for config files

Write to temp file then rename to prevent partial writes on
crash or power loss. Affects settings.json, defaults.json,
and baseDeltas.json.
---
 src/config/config.ts | 31 +++++++++++++++++++++++++++++--
 src/deltaeditor.ts   | 28 ++++++++++++++++++++++++----
 2 files changed, 53 insertions(+), 6 deletions(-)

diff --git a/src/config/config.ts b/src/config/config.ts
index dd3dd320..2fc65bb3 100644
--- a/src/config/config.ts
+++ b/src/config/config.ts
@@ -354,7 +354,21 @@ export function sendBaseDeltas(app: ConfigApp) {
 }
 
 export function writeDefaultsFile(app: ConfigApp, defaults: any, cb: any) {
-  fs.writeFile(getDefaultsPath(app), JSON.stringify(defaults, null, 2), cb)
+  const defaultsPath = getDefaultsPath(app)
+  const tempPath = defaultsPath + '.tmp'
+  const data = JSON.stringify(defaults, null, 2)
+  fs.writeFile(tempPath, data, (writeErr) => {
+    if (writeErr) {
+      return cb(writeErr)
+    }
+    fs.rename(tempPath, defaultsPath, (renameErr) => {
+      if (renameErr) {
+        fs.unlink(tempPath, () => cb(renameErr))
+      } else {
+        cb()
+      }
+    })
+  })
 }
 
 export function writeBaseDeltasFileSync(app: ConfigApp) {
@@ -430,7 +444,20 @@ function readSettingsFile(app: ConfigApp) {
 export function writeSettingsFile(app: ConfigApp, settings: any, cb: any) {
   if (!disableWriteSettings) {
     const settingsPath = getSettingsFilename(app)
-    fs.writeFile(settingsPath, JSON.stringify(settings, null, 2), cb)
+    const tempPath = settingsPath + '.tmp'
+    const data = JSON.stringify(settings, null, 2)
+    fs.writeFile(tempPath, data, (writeErr) => {
+      if (writeErr) {
+        return cb(writeErr)
+      }
+      fs.rename(tempPath, settingsPath, (renameErr) => {
+        if (renameErr) {
+          fs.unlink(tempPath, () => cb(renameErr))
+        } else {
+          cb()
+        }
+      })
+    })
   } else {
     cb()
   }
diff --git a/src/deltaeditor.ts b/src/deltaeditor.ts
index e6e7d406..fc6979a3 100644
--- a/src/deltaeditor.ts
+++ b/src/deltaeditor.ts
@@ -40,11 +40,31 @@ class DeltaEditor {
   }
 
   saveSync(filename: string) {
-    fs.writeFileSync(filename, JSON.stringify(this.deltas, null, 2))
+    const tempPath = filename + '.tmp'
+    const data = JSON.stringify(this.deltas, null, 2)
+    try {
+      fs.writeFileSync(tempPath, data)
+      fs.renameSync(tempPath, filename)
+    } catch (err) {
+      try {
+        fs.unlinkSync(tempPath)
+      } catch {}
+      throw err
+    }
+  }
+
+  async save(filename: string): Promise<void> {
+    const tempPath = filename + '.tmp'
+    const data = JSON.stringify(this.deltas, null, 2)
+    try {
+      await fs.promises.writeFile(tempPath, data)
+      await fs.promises.rename(tempPath, filename)
+    } catch (err) {
+      try {
+        await fs.promises.unlink(tempPath)
+      } catch {}
+      throw err
     }
-
-  save(filename: string): Promise<any> {
-    return fs.promises.writeFile(filename, JSON.stringify(this.deltas, null, 2))
   }
 
   setValue(context: string, path: string, value: any) {
-- 
2.51.0.windows.2

