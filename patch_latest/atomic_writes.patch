From 0bde9744aa3fed5262f36af54af78bb0db31ef89 Mon Sep 17 00:00:00 2001
From: Karl-Erik Gustafsson <ke.gustafsson@gmail.com>
Date: Tue, 6 Jan 2026 01:14:19 +0200
Subject: [PATCH] Claude/atomic helper function q i uat (#52)

* refactor: extract atomic write operations into helper functions

Created reusable atomic write helper functions to reduce code
duplication. The helpers implement write-then-rename pattern
to prevent partial writes on crash or power loss.

Changes:
- Added src/atomicWrite.ts with three helper functions:
  - atomicWriteFile (callback-based)
  - atomicWriteFileSync (synchronous)
  - atomicWriteFileAsync (async/await)
- Refactored config.ts to use atomicWriteFile helper in:
  - writeDefaultsFile
  - writeSettingsFile
- Refactored deltaeditor.ts to use helpers in:
  - saveSync (uses atomicWriteFileSync)
  - save (uses atomicWriteFileAsync)

This reduces code duplication and makes the atomic write pattern
more maintainable and consistent across the codebase.

* refactor: simplify atomic write helpers

* refactor: use single atomic write helper

* fix: restore async behavior for atomic writes

---------

Co-authored-by: Claude <noreply@anthropic.com>
---
 src/atomicWrite.ts   | 23 +++++++++++++++++++++++
 src/config/config.ts | 10 +++++++---
 src/deltaeditor.ts   |  8 +++++---
 3 files changed, 35 insertions(+), 6 deletions(-)
 create mode 100644 src/atomicWrite.ts

diff --git a/src/atomicWrite.ts b/src/atomicWrite.ts
new file mode 100644
index 000000000..faf6227a8
--- /dev/null
+++ b/src/atomicWrite.ts
@@ -0,0 +1,23 @@
+import fs from 'fs'
+
+export function atomicWriteFileSync(filePath: string, data: string): void {
+  const tmp = filePath + '.tmp'
+  try {
+    fs.writeFileSync(tmp, data)
+    fs.renameSync(tmp, filePath)
+  } catch (err) {
+    try { fs.unlinkSync(tmp) } catch {}
+    throw err
+  }
+}
+
+export async function atomicWriteFile(filePath: string, data: string): Promise<void> {
+  const tmp = filePath + '.tmp'
+  try {
+    await fs.promises.writeFile(tmp, data)
+    await fs.promises.rename(tmp, filePath)
+  } catch (err) {
+    try { await fs.promises.unlink(tmp) } catch {}
+    throw err
+  }
+}
diff --git a/src/config/config.ts b/src/config/config.ts
index dd3dd320f..aa79c7528 100644
--- a/src/config/config.ts
+++ b/src/config/config.ts
@@ -28,6 +28,7 @@ import { ServerApp, SignalKMessageHub, WithConfig } from '../app'
 import { createDebug } from '../debug'
 import DeltaEditor from '../deltaeditor'
 import { getExternalPort } from '../ports'
+import { atomicWriteFile } from '../atomicWrite'
 const debug = createDebug('signalk-server:config')
 
 let disableWriteSettings = false
@@ -354,7 +355,9 @@ export function sendBaseDeltas(app: ConfigApp) {
 }
 
 export function writeDefaultsFile(app: ConfigApp, defaults: any, cb: any) {
-  fs.writeFile(getDefaultsPath(app), JSON.stringify(defaults, null, 2), cb)
+  atomicWriteFile(getDefaultsPath(app), JSON.stringify(defaults, null, 2))
+    .then(() => cb())
+    .catch(cb)
 }
 
 export function writeBaseDeltasFileSync(app: ConfigApp) {
@@ -429,8 +432,9 @@ function readSettingsFile(app: ConfigApp) {
 
 export function writeSettingsFile(app: ConfigApp, settings: any, cb: any) {
   if (!disableWriteSettings) {
-    const settingsPath = getSettingsFilename(app)
-    fs.writeFile(settingsPath, JSON.stringify(settings, null, 2), cb)
+    atomicWriteFile(getSettingsFilename(app), JSON.stringify(settings, null, 2))
+      .then(() => cb())
+      .catch(cb)
   } else {
     cb()
   }
diff --git a/src/deltaeditor.ts b/src/deltaeditor.ts
index e6e7d406f..9afdc15b9 100644
--- a/src/deltaeditor.ts
+++ b/src/deltaeditor.ts
@@ -17,6 +17,7 @@
 
 import fs from 'fs'
 import _ from 'lodash'
+import { atomicWriteFileSync, atomicWriteFile } from './atomicWrite'
 
 const VALUES = 'values'
 const META = 'meta'
@@ -40,11 +41,12 @@ class DeltaEditor {
   }
 
   saveSync(filename: string) {
-    fs.writeFileSync(filename, JSON.stringify(this.deltas, null, 2))
+    const data = JSON.stringify(this.deltas, null, 2)
+    atomicWriteFileSync(filename, data)
   }
 
-  save(filename: string): Promise<any> {
-    return fs.promises.writeFile(filename, JSON.stringify(this.deltas, null, 2))
+  save(filename: string): Promise<void> {
+    return atomicWriteFile(filename, JSON.stringify(this.deltas, null, 2))
   }
 
   setValue(context: string, path: string, value: any) {
