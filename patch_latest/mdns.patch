From 919b6b81b298babb37ffa7e9a09915c4c14c7fc9 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Tue, 27 Jan 2026 00:43:05 +0000
Subject: [PATCH 1/2] fix(mdns): remove duplicate HTTP/HTTPS service
 registration from REST interface

The REST interface was registering an mDNS service for signalk-http/signalk-https,
duplicating the primary service already published in src/mdns.js. With bonjour-service,
this duplicate registration can cause mDNS to fail.

https://claude.ai/code/session_011HdHm5zayftQjrCPdt8BJW
---
 src/interfaces/rest.js | 6 ------
 1 file changed, 6 deletions(-)

diff --git a/src/interfaces/rest.js b/src/interfaces/rest.js
index df19c9af0..0b9350232 100644
--- a/src/interfaces/rest.js
+++ b/src/interfaces/rest.js
@@ -175,12 +175,6 @@ module.exports = function (app) {
         app.historyProvider.registerHistoryApiRoute(historyApiRouter)
         app.use(pathPrefix + versionPrefix + '/history', historyApiRouter)
       }
-    },
-
-    mdns: {
-      name: app.config.settings.ssl ? '_signalk-https' : '_signalk-http',
-      type: 'tcp',
-      port: ports.getExternalPort(app)
     }
   }
 }

From 4492219c32d6256bf2bfad002f953470936a3b8f Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Tue, 27 Jan 2026 01:02:23 +0000
Subject: [PATCH 2/2] refactor(mdns): consolidate to single library
 (bonjour-service)

Replace mdns-js with bonjour-service for mDNS discovery, unifying the
codebase on a single mDNS library. Both publishing (mdns.js) and
discovery (discovery.js) now use bonjour-service.

Benefits:
- Fewer dependencies (removed mdns-js)
- Consistent API for publish and discover
- Simpler maintenance

https://claude.ai/code/session_011HdHm5zayftQjrCPdt8BJW
---
 package.json     |  1 -
 src/discovery.js | 38 +++++++++++++++++---------------------
 2 files changed, 17 insertions(+), 22 deletions(-)

diff --git a/package.json b/package.json
index e7ffc5fe7..607c0397f 100644
--- a/package.json
+++ b/package.json
@@ -111,7 +111,6 @@
     "jsonwebtoken": "^9.0.0",
     "listr": "^0.14.1",
     "lodash": "^4.17.21",
-    "mdns-js": "^1.0.3",
     "minimist": "^1.2.8",
     "moment": "^2.10.6",
     "morgan": "^1.5.0",
diff --git a/src/discovery.js b/src/discovery.js
index 5da0aee0a..e19963965 100644
--- a/src/discovery.js
+++ b/src/discovery.js
@@ -18,7 +18,7 @@ import { createDebug } from './debug'
 const debug = createDebug('signalk-server:discovery')
 const canboatjs = require('@canboat/canboatjs')
 const dgram = require('dgram')
-const mdns = require('mdns-js')
+const { Bonjour } = require('bonjour-service')
 const { networkInterfaces } = require('os')
 
 module.exports.runDiscovery = function (app) {
@@ -196,28 +196,23 @@ module.exports.runDiscovery = function (app) {
 
   function discoverSignalkWs(wsType) {
     try {
-      mdns.excludeInterface('0.0.0.0')
-      var browser = mdns.createBrowser(mdns.tcp('signalk-' + wsType))
+      const bonjour = new Bonjour()
+      debug('looking for SignalK ' + wsType)
+      const browser = bonjour.find({ type: 'signalk-' + wsType })
 
-      browser.on('ready', function onReady() {
-        try {
-          debug('looking for SignalK ' + wsType)
-          browser.discover()
-        } catch (err) {
-          debug('discoverSignalkWs:', err)
-        }
-      })
-
-      browser.on('update', function onUpdate(data) {
+      browser.on('up', function onUp(service) {
         try {
+          const address =
+            service.addresses && service.addresses.length > 0
+              ? service.addresses[0]
+              : null
           if (
-            !isLocalIP(data.addresses[0]) &&
-            Array.isArray(data.type) &&
-            data.type[0].name === 'signalk-' + wsType &&
-            !findWSProvider(data.addresses[0], wsType, data.host, data.port)
+            address &&
+            !isLocalIP(address) &&
+            !findWSProvider(address, wsType, service.host, service.port)
           ) {
-            debug('discoverSignalkWs found data[' + wsType + ']:', data)
-            const providerId = wsType + '-' + data.host + ':' + data.port
+            debug('discoverSignalkWs found service[' + wsType + ']:', service)
+            const providerId = wsType + '-' + service.host + ':' + service.port
             app.emit('discovered', {
               id: providerId,
               enabled: false,
@@ -228,8 +223,8 @@ module.exports.runDiscovery = function (app) {
                     type: 'SignalK',
                     subOptions: {
                       type: wsType,
-                      host: data.host,
-                      port: data.port,
+                      host: service.host,
+                      port: service.port,
                       providerId: providerId
                     },
                     providerId: providerId
@@ -246,6 +241,7 @@ module.exports.runDiscovery = function (app) {
       setTimeout(() => {
         try {
           browser.stop()
+          bonjour.destroy()
           debug('discoverSignalkWs close')
         } catch (err) {
           debug('discoverSignalkWs:', err)
