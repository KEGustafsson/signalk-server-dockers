From 52d64bd258c8365ae4742de8a17bccee2cfc1af5 Mon Sep 17 00:00:00 2001
From: KE Gustafsson <ke.gustafsson@gmail.com>
Date: Sat, 21 Feb 2026 16:30:26 +0200
Subject: [PATCH 1/2] fix(admin-ui): show ws n2k labels in source views

Resolve ws.* source references to human-readable labels from
sources.ws.<device>.n2k.description.

Apply label resolution in Dashboard, Data Browser, and Source Priorities
for both server-admin-ui and server-admin-ui-react19.

Add shared /sources polling helpers and keep sourceRef fallback when
no ws n2k description is available.
---
 .../src/hooks/sourceLabelUtils.test.ts        | 46 +++++++++++++++++++
 .../src/hooks/sourceLabelUtils.ts             | 38 +++++++++++++++
 .../src/hooks/useSources.ts                   | 36 +++++++++++++++
 .../src/views/Dashboard/Dashboard.tsx         | 15 ++++--
 .../src/views/DataBrowser/DataRow.tsx         |  8 +++-
 .../DataBrowser/VirtualizedDataTable.tsx      |  3 ++
 .../views/ServerConfig/SourcePriorities.tsx   | 15 ++++--
 .../src/utils/sourceLabelUtils.js             | 29 ++++++++++++
 .../server-admin-ui/src/utils/useSources.js   | 37 +++++++++++++++
 .../src/views/Dashboard/Dashboard.js          | 16 +++++--
 .../src/views/DataBrowser/DataBrowser.js      |  6 +--
 .../src/views/DataBrowser/DataRow.js          |  7 ++-
 .../views/DataBrowser/VirtualizedDataTable.js |  3 ++
 .../views/ServerConfig/SourcePriorities.js    | 42 +++++++++++++++--
 14 files changed, 279 insertions(+), 22 deletions(-)
 create mode 100644 packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.test.ts
 create mode 100644 packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.ts
 create mode 100644 packages/server-admin-ui-react19/src/hooks/useSources.ts
 create mode 100644 packages/server-admin-ui/src/utils/sourceLabelUtils.js
 create mode 100644 packages/server-admin-ui/src/utils/useSources.js

diff --git a/packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.test.ts b/packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.test.ts
new file mode 100644
index 000000000..599545af5
--- /dev/null
+++ b/packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.test.ts
@@ -0,0 +1,46 @@
+import { describe, it, expect } from 'vitest'
+import { getSourceDisplayLabel } from './sourceLabelUtils'
+
+describe('sourceLabelUtils', () => {
+  it('uses n2k description for nested ws source refs', () => {
+    const sources = {
+      ws: {
+        myDevice: {
+          n2k: {
+            description: 'Cabin Tablet'
+          }
+        }
+      }
+    }
+
+    expect(getSourceDisplayLabel('ws.myDevice.n2k.204', sources)).toBe(
+      'Cabin Tablet'
+    )
+  })
+
+  it('falls back to sourceRef when ws n2k description is missing', () => {
+    const sources = {
+      ws: {
+        myDevice: {
+          description: 'Top-level only'
+        }
+      }
+    }
+
+    expect(getSourceDisplayLabel('ws.myDevice.n2k.204', sources)).toBe(
+      'ws.myDevice.n2k.204'
+    )
+  })
+
+  it('falls back to sourceRef for non-ws source refs', () => {
+    const sources = {
+      nmea0183: {
+        tcp: {
+          description: 'NMEA tcp'
+        }
+      }
+    }
+
+    expect(getSourceDisplayLabel('nmea0183.tcp', sources)).toBe('nmea0183.tcp')
+  })
+})
diff --git a/packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.ts b/packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.ts
new file mode 100644
index 000000000..18830ff65
--- /dev/null
+++ b/packages/server-admin-ui-react19/src/hooks/sourceLabelUtils.ts
@@ -0,0 +1,38 @@
+interface SourceMetadata {
+  n2k?: {
+    description?: string
+  }
+  [key: string]: unknown
+}
+
+function getWsSourceMetadata(
+  sourceRef: string,
+  sources: Record<string, unknown>
+): SourceMetadata | null {
+  if (!sourceRef?.startsWith('ws.') || !sources || typeof sources !== 'object') {
+    return null
+  }
+
+  const parts = sourceRef.split('.')
+  const wsDeviceId = parts[1]
+  if (!wsDeviceId) {
+    return null
+  }
+
+  const wsSources = sources.ws
+  if (!wsSources || typeof wsSources !== 'object') {
+    return null
+  }
+
+  const node = (wsSources as Record<string, unknown>)[wsDeviceId]
+  return node && typeof node === 'object' ? (node as SourceMetadata) : null
+}
+
+export function getSourceDisplayLabel(
+  sourceRef: string,
+  sources: Record<string, unknown> = {}
+): string {
+  const metadata = getWsSourceMetadata(sourceRef, sources)
+  const description = metadata?.n2k?.description
+  return description || sourceRef
+}
diff --git a/packages/server-admin-ui-react19/src/hooks/useSources.ts b/packages/server-admin-ui-react19/src/hooks/useSources.ts
new file mode 100644
index 000000000..3aeb4b013
--- /dev/null
+++ b/packages/server-admin-ui-react19/src/hooks/useSources.ts
@@ -0,0 +1,36 @@
+import { useState, useEffect } from 'react'
+
+export function fetchSourcesData(): Promise<Record<string, unknown>> {
+  return fetch('/signalk/v1/api/sources', {
+    credentials: 'include'
+  }).then((response) => response.json())
+}
+
+export function useSources(pollInterval = 30000): Record<string, unknown> {
+  const [sources, setSources] = useState<Record<string, unknown>>({})
+
+  useEffect(() => {
+    let canceled = false
+
+    const doFetch = () => {
+      fetchSourcesData()
+        .then((data) => {
+          if (!canceled) {
+            setSources(data)
+          }
+        })
+        .catch(() => undefined)
+    }
+
+    doFetch()
+    const interval =
+      pollInterval > 0 ? setInterval(doFetch, pollInterval) : null
+
+    return () => {
+      canceled = true
+      if (interval) clearInterval(interval)
+    }
+  }, [pollInterval])
+
+  return sources
+}
diff --git a/packages/server-admin-ui-react19/src/views/Dashboard/Dashboard.tsx b/packages/server-admin-ui-react19/src/views/Dashboard/Dashboard.tsx
index a535ffb51..03f1bbdbb 100644
--- a/packages/server-admin-ui-react19/src/views/Dashboard/Dashboard.tsx
+++ b/packages/server-admin-ui-react19/src/views/Dashboard/Dashboard.tsx
@@ -10,6 +10,8 @@ import { faSignIn } from '@fortawesome/free-solid-svg-icons/faSignIn'
 import { faSignOut } from '@fortawesome/free-solid-svg-icons/faSignOut'
 import { useServerStats, useWsStatus, useStore } from '../../store'
 import type { ProviderStatistics } from '../../store/types'
+import { useSources } from '../../hooks/useSources'
+import { getSourceDisplayLabel } from '../../hooks/sourceLabelUtils'
 import '../../fa-pulse.css'
 
 interface ProviderStatusItem {
@@ -27,6 +29,7 @@ export default function Dashboard() {
   const providerStatus =
     (useStore((state) => state.providerStatus) as ProviderStatusItem[]) || []
   const navigate = useNavigate()
+  const sources = useSources()
 
   const deltaRate = serverStatistics?.deltaRate ?? 0
   const numberOfAvailablePaths = serverStatistics?.numberOfAvailablePaths ?? 0
@@ -74,6 +77,7 @@ export default function Dashboard() {
     providerStats: ProviderStatistics,
     linkType: string
   ): ReactNode => {
+    const label = getSourceDisplayLabel(providerId, sources)
     const iconStyle = {
       fontSize: '18px',
       marginLeft: '5px',
@@ -100,7 +104,7 @@ export default function Dashboard() {
         <span className="title">
           {linkType === 'plugin'
             ? pluginNameLink(providerId)
-            : providerIdLink(providerId)}
+            : providerIdLink(providerId, label)}
         </span>
         {(providerStats.writeRate || 0) > 0 && (
           <span className="value" style={{ fontWeight: 'normal' }}>
@@ -160,7 +164,10 @@ export default function Dashboard() {
         <td>
           {status.statusType === 'plugin'
             ? pluginNameLink(status.id)
-            : providerIdLink(status.id)}
+            : providerIdLink(
+                status.id,
+                getSourceDisplayLabel(status.id, sources)
+              )}
         </td>
         <td>
           <p className="text-danger">{lastError}</p>
@@ -313,11 +320,11 @@ function pluginNameLink(id: string): ReactNode {
   return <a href={'#/serverConfiguration/plugins/' + id}>{id}</a>
 }
 
-function providerIdLink(id: string): ReactNode {
+function providerIdLink(id: string, label?: string): ReactNode {
   if (id === 'defaults') {
     return <a href={'#/serverConfiguration/settings'}>{id}</a>
   } else if (id.startsWith('ws.')) {
-    return <a href={'#/security/devices'}>{id}</a>
+    return <a href={'#/security/devices'}>{label || id}</a>
   } else {
     return <a href={'#/serverConfiguration/connections/' + id}>{id}</a>
   }
diff --git a/packages/server-admin-ui-react19/src/views/DataBrowser/DataRow.tsx b/packages/server-admin-ui-react19/src/views/DataBrowser/DataRow.tsx
index 7a1fe7486..49481c3a6 100644
--- a/packages/server-admin-ui-react19/src/views/DataBrowser/DataRow.tsx
+++ b/packages/server-admin-ui-react19/src/views/DataBrowser/DataRow.tsx
@@ -3,6 +3,7 @@ import { usePathData, useMetaData } from './usePathData'
 import TimestampCell from './TimestampCell'
 import CopyToClipboardWithFade from './CopyToClipboardWithFade'
 import { getValueRenderer, DefaultValueRenderer } from './ValueRenderers'
+import { getSourceDisplayLabel } from '../../hooks/sourceLabelUtils'
 import type { PathData, MetaData } from '../../store'
 
 interface DataRowProps {
@@ -14,6 +15,7 @@ interface DataRowProps {
   onToggleSource: (source: string) => void
   selectedSources: Set<string>
   showContext: boolean
+  sources: Record<string, unknown>
 }
 
 interface ValueRendererProps {
@@ -31,7 +33,8 @@ function DataRow({
   isPaused,
   onToggleSource,
   selectedSources,
-  showContext
+  showContext,
+  sources
 }: DataRowProps) {
   // When showContext is true, path$SourceKey is a composite key: context\0realKey
   const nullIdx = showContext ? path$SourceKey.indexOf('\0') : -1
@@ -122,7 +125,8 @@ function DataRow({
           />
         </label>
         <CopyToClipboardWithFade text={source}>
-          {source} <span className="copy-icon" aria-hidden="true" />
+          {getSourceDisplayLabel(source, sources)}{' '}
+          <span className="copy-icon" aria-hidden="true" />
         </CopyToClipboardWithFade>{' '}
         {data.pgn && <span>&nbsp;{data.pgn}</span>}
         {data.sentence && <span>&nbsp;{data.sentence}</span>}
diff --git a/packages/server-admin-ui-react19/src/views/DataBrowser/VirtualizedDataTable.tsx b/packages/server-admin-ui-react19/src/views/DataBrowser/VirtualizedDataTable.tsx
index 1d6eb1953..e2eaabeec 100644
--- a/packages/server-admin-ui-react19/src/views/DataBrowser/VirtualizedDataTable.tsx
+++ b/packages/server-admin-ui-react19/src/views/DataBrowser/VirtualizedDataTable.tsx
@@ -8,6 +8,7 @@ import {
 } from 'react'
 import DataRow from './DataRow'
 import granularSubscriptionManager from './GranularSubscriptionManager'
+import { useSources } from '../../hooks/useSources'
 import './VirtualTable.css'
 
 interface VisibleItem {
@@ -38,6 +39,7 @@ function VirtualizedDataTable({
   sourceFilterActive,
   showContext
 }: VirtualizedDataTableProps) {
+  const sources = useSources()
   const containerRef = useRef<HTMLDivElement>(null)
   const [isNarrowScreen, setIsNarrowScreen] = useState(
     typeof window !== 'undefined' && window.innerWidth <= 768
@@ -236,6 +238,7 @@ function VirtualizedDataTable({
             onToggleSource={onToggleSource}
             selectedSources={selectedSources}
             showContext={showContext}
+            sources={sources}
           />
         ))}
 
diff --git a/packages/server-admin-ui-react19/src/views/ServerConfig/SourcePriorities.tsx b/packages/server-admin-ui-react19/src/views/ServerConfig/SourcePriorities.tsx
index e90c65730..4ba08030c 100644
--- a/packages/server-admin-ui-react19/src/views/ServerConfig/SourcePriorities.tsx
+++ b/packages/server-admin-ui-react19/src/views/ServerConfig/SourcePriorities.tsx
@@ -14,6 +14,8 @@ import { faFloppyDisk } from '@fortawesome/free-solid-svg-icons/faFloppyDisk'
 import Creatable from 'react-select/creatable'
 import uniq from 'lodash.uniq'
 import { useStore, useSourcePriorities } from '../../store'
+import { useSources } from '../../hooks/useSources'
+import { getSourceDisplayLabel } from '../../hooks/sourceLabelUtils'
 
 // Types
 interface Priority {
@@ -51,13 +53,15 @@ interface PrefsEditorProps {
   priorities: Priority[]
   pathIndex: number
   isSaving: boolean
+  sources: Record<string, unknown>
 }
 
 const PrefsEditor: React.FC<PrefsEditorProps> = ({
   path,
   priorities,
   pathIndex,
-  isSaving
+  isSaving,
+  sources
 }) => {
   const changePriority = useStore((s) => s.changePriority)
   const deletePriority = useStore((s) => s.deletePriority)
@@ -76,8 +80,11 @@ const PrefsEditor: React.FC<PrefsEditorProps> = ({
 
   const toggleEditor = () => setIsOpen((prev) => !prev)
 
+  const resolveSourceLabel = (ref: string): string =>
+    getSourceDisplayLabel(ref, sources)
+
   const options: SelectOption[] = sourceRefs.map((ref) => ({
-    label: ref,
+    label: resolveSourceLabel(ref),
     value: ref
   }))
 
@@ -107,7 +114,7 @@ const PrefsEditor: React.FC<PrefsEditorProps> = ({
                       <Creatable
                         menuPortalTarget={document.body}
                         options={options}
-                        value={{ value: sourceRef, label: sourceRef }}
+                        value={{ value: sourceRef, label: resolveSourceLabel(sourceRef) }}
                         onChange={(e) => {
                           changePriority(
                             pathIndex,
@@ -199,6 +206,7 @@ const SourcePriorities: React.FC = () => {
   const { sourcePriorities, saveState } = sourcePrioritiesData
 
   const [availablePaths, setAvailablePaths] = useState<SelectOption[]>([])
+  const sources = useSources()
 
   useEffect(() => {
     fetchAvailablePaths((pathsArray) => {
@@ -312,6 +320,7 @@ const SourcePriorities: React.FC = () => {
                       priorities={priorities}
                       pathIndex={index}
                       isSaving={saveState.isSaving || false}
+                      sources={sources}
                     />
                   </td>
                   <td style={{ border: 'none' }}>
diff --git a/packages/server-admin-ui/src/utils/sourceLabelUtils.js b/packages/server-admin-ui/src/utils/sourceLabelUtils.js
new file mode 100644
index 000000000..0d1100048
--- /dev/null
+++ b/packages/server-admin-ui/src/utils/sourceLabelUtils.js
@@ -0,0 +1,29 @@
+function getWsSourceMetadata(sourceRef, sources) {
+  if (
+    !sourceRef?.startsWith('ws.') ||
+    !sources ||
+    typeof sources !== 'object'
+  ) {
+    return null
+  }
+
+  const parts = sourceRef.split('.')
+  const wsDeviceId = parts[1]
+  if (!wsDeviceId) {
+    return null
+  }
+
+  const wsSources = sources.ws
+  if (!wsSources || typeof wsSources !== 'object') {
+    return null
+  }
+
+  const node = wsSources[wsDeviceId]
+  return node && typeof node === 'object' ? node : null
+}
+
+export function getSourceDisplayLabel(sourceRef, sources = {}) {
+  const metadata = getWsSourceMetadata(sourceRef, sources)
+  const description = metadata?.n2k?.description
+  return description || sourceRef
+}
diff --git a/packages/server-admin-ui/src/utils/useSources.js b/packages/server-admin-ui/src/utils/useSources.js
new file mode 100644
index 000000000..be2f7471d
--- /dev/null
+++ b/packages/server-admin-ui/src/utils/useSources.js
@@ -0,0 +1,37 @@
+import { useState, useEffect } from 'react'
+
+export function fetchSourcesData() {
+  return fetch('/signalk/v1/api/sources', {
+    credentials: 'include'
+  }).then((response) => response.json())
+}
+
+export function useSources(pollInterval = 30000) {
+  const [sources, setSources] = useState({})
+
+  useEffect(() => {
+    let canceled = false
+
+    const doFetch = () => {
+      fetchSourcesData()
+        .then((data) => {
+          if (!canceled) {
+            setSources(data)
+          }
+        })
+        .catch(() => undefined)
+    }
+
+    doFetch()
+    const interval = pollInterval > 0
+      ? setInterval(doFetch, pollInterval)
+      : null
+
+    return () => {
+      canceled = true
+      if (interval) clearInterval(interval)
+    }
+  }, [pollInterval])
+
+  return sources
+}
diff --git a/packages/server-admin-ui/src/views/Dashboard/Dashboard.js b/packages/server-admin-ui/src/views/Dashboard/Dashboard.js
index b7ecbec79..66543adf7 100644
--- a/packages/server-admin-ui/src/views/Dashboard/Dashboard.js
+++ b/packages/server-admin-ui/src/views/Dashboard/Dashboard.js
@@ -10,8 +10,12 @@ import {
   Table
 } from 'reactstrap'
 import '../../fa-pulse.css'
+import { getSourceDisplayLabel } from '../../utils/sourceLabelUtils'
+import { useSources } from '../../utils/useSources'
 
 const Dashboard = (props) => {
+  const sources = useSources()
+
   const {
     deltaRate,
     numberOfAvailablePaths,
@@ -66,6 +70,7 @@ const Dashboard = (props) => {
   }
 
   const renderActivity = (providerId, providerStats, linkType) => {
+    const label = getSourceDisplayLabel(providerId, sources)
     return (
       <li key={providerId} onClick={() => props.history.push(`/dashboard`)}>
         <i
@@ -84,7 +89,7 @@ const Dashboard = (props) => {
         <span className="title">
           {linkType === 'plugin'
             ? pluginNameLink(providerId)
-            : providerIdLink(providerId)}
+            : providerIdLink(providerId, label)}
         </span>
         {providerStats.writeRate > 0 && (
           <span className="value">
@@ -136,7 +141,10 @@ const Dashboard = (props) => {
         <td>
           {status.statusType === 'plugin'
             ? pluginNameLink(status.id)
-            : providerIdLink(status.id)}
+            : providerIdLink(
+                status.id,
+                getSourceDisplayLabel(status.id, sources)
+              )}
         </td>
         <td>
           <p className="text-danger">{lastError}</p>
@@ -286,11 +294,11 @@ function pluginNameLink(id) {
   return <a href={'#/serverConfiguration/plugins/' + id}>{id}</a>
 }
 
-function providerIdLink(id) {
+function providerIdLink(id, label) {
   if (id === 'defaults') {
     return <a href={'#/serverConfiguration/settings'}>{id}</a>
   } else if (id.startsWith('ws.')) {
-    return <a href={'#/security/devices'}>{id}</a>
+    return <a href={'#/security/devices'}>{label || id}</a>
   } else {
     return <a href={'#/serverConfiguration/connections/' + id}>{id}</a>
   }
diff --git a/packages/server-admin-ui/src/views/DataBrowser/DataBrowser.js b/packages/server-admin-ui/src/views/DataBrowser/DataBrowser.js
index d97b5a4c0..3c9267707 100644
--- a/packages/server-admin-ui/src/views/DataBrowser/DataBrowser.js
+++ b/packages/server-admin-ui/src/views/DataBrowser/DataBrowser.js
@@ -2,6 +2,7 @@ import React, { Component } from 'react'
 import { connect } from 'react-redux'
 import { JSONTree } from 'react-json-tree'
 import Select from 'react-select'
+import { fetchSourcesData } from '../../utils/useSources'
 import {
   Card,
   CardHeader,
@@ -32,10 +33,7 @@ const selectedSourcesStorageKey = 'admin.v1.dataBrowser.selectedSources'
 const sourceFilterActiveStorageKey = 'admin.v1.dataBrowser.sourceFilterActive'
 
 function fetchSources() {
-  fetch(`/signalk/v1/api/sources`, {
-    credentials: 'include'
-  })
-    .then((response) => response.json())
+  fetchSourcesData()
     .then((sources) => {
       Object.values(sources).forEach((source) => {
         if (source.type === 'NMEA2000') {
diff --git a/packages/server-admin-ui/src/views/DataBrowser/DataRow.js b/packages/server-admin-ui/src/views/DataBrowser/DataRow.js
index 1a7eb4473..71611fa11 100644
--- a/packages/server-admin-ui/src/views/DataBrowser/DataRow.js
+++ b/packages/server-admin-ui/src/views/DataBrowser/DataRow.js
@@ -3,6 +3,7 @@ import { usePathData, useMetaData } from './usePathData'
 import TimestampCell from './TimestampCell'
 import CopyToClipboardWithFade from './CopyToClipboardWithFade'
 import { getValueRenderer, DefaultValueRenderer } from './ValueRenderers'
+import { getSourceDisplayLabel } from '../../utils/sourceLabelUtils'
 
 /**
  * DataRow - Individual virtualized row with granular subscription
@@ -15,7 +16,8 @@ function DataRow({
   raw,
   isPaused,
   onToggleSource,
-  selectedSources
+  selectedSources,
+  sources
 }) {
   const data = usePathData(context, path$SourceKey)
   const meta = useMetaData(context, data?.path)
@@ -73,7 +75,8 @@ function DataRow({
           }}
         />
         <CopyToClipboardWithFade text={data.$source}>
-          {data.$source} <i className="far fa-copy"></i>
+          {getSourceDisplayLabel(data.$source, sources)}{' '}
+          <i className="far fa-copy"></i>
         </CopyToClipboardWithFade>
         {data.pgn && <span>&nbsp;{data.pgn}</span>}
         {data.sentence && <span>&nbsp;{data.sentence}</span>}
diff --git a/packages/server-admin-ui/src/views/DataBrowser/VirtualizedDataTable.js b/packages/server-admin-ui/src/views/DataBrowser/VirtualizedDataTable.js
index a034be7a6..87d650f0d 100644
--- a/packages/server-admin-ui/src/views/DataBrowser/VirtualizedDataTable.js
+++ b/packages/server-admin-ui/src/views/DataBrowser/VirtualizedDataTable.js
@@ -1,6 +1,7 @@
 import React, { useRef, useEffect, useState, useCallback, useMemo } from 'react'
 import DataRow from './DataRow'
 import granularSubscriptionManager from './GranularSubscriptionManager'
+import { useSources } from '../../utils/useSources'
 import './VirtualTable.css'
 
 /**
@@ -17,6 +18,7 @@ function VirtualizedDataTable({
   onToggleSourceFilter,
   sourceFilterActive
 }) {
+  const sources = useSources()
   const containerRef = useRef(null)
   const [visibleRange, setVisibleRange] = useState({ start: 0, end: 50 })
   const [isNarrowScreen, setIsNarrowScreen] = useState(
@@ -236,6 +238,7 @@ function VirtualizedDataTable({
             isPaused={isPaused}
             onToggleSource={onToggleSource}
             selectedSources={selectedSources}
+            sources={sources}
           />
         ))}
 
diff --git a/packages/server-admin-ui/src/views/ServerConfig/SourcePriorities.js b/packages/server-admin-ui/src/views/ServerConfig/SourcePriorities.js
index 20f5c49c5..32a4dbb01 100644
--- a/packages/server-admin-ui/src/views/ServerConfig/SourcePriorities.js
+++ b/packages/server-admin-ui/src/views/ServerConfig/SourcePriorities.js
@@ -15,6 +15,8 @@ import {
 import Creatable from 'react-select/creatable'
 import remove from 'lodash.remove'
 import uniq from 'lodash.uniq'
+import { getSourceDisplayLabel } from '../../utils/sourceLabelUtils'
+import { fetchSourcesData } from '../../utils/useSources'
 
 export const SOURCEPRIOS_PRIO_CHANGED = 'SOURCEPRIOS_PPRIO_CHANGED'
 export const SOURCEPRIOS_PRIO_DELETED = 'SOURCEPRIOS_PRIO_DELETED'
@@ -189,8 +191,11 @@ class PrefsEditor extends Component {
             <tbody>
               {[...this.props.priorities, { sourceRef: '', timeout: '' }].map(
                 ({ sourceRef, timeout }, index) => {
+                  const { resolveSourceLabel } = this.props
                   const options = this.state.sourceRefs.map((sourceRef) => ({
-                    label: sourceRef,
+                    label: resolveSourceLabel
+                      ? resolveSourceLabel(sourceRef)
+                      : sourceRef,
                     value: sourceRef
                   }))
                   return (
@@ -200,7 +205,12 @@ class PrefsEditor extends Component {
                         <Creatable
                           menuPortalTarget={document.body}
                           options={options}
-                          value={{ value: sourceRef, label: sourceRef }}
+                          value={{
+                            value: sourceRef,
+                            label: resolveSourceLabel
+                              ? resolveSourceLabel(sourceRef)
+                              : sourceRef
+                          }}
                           onChange={(e) => {
                             this.props.dispatch({
                               type: SOURCEPRIOS_PRIO_CHANGED,
@@ -348,7 +358,8 @@ class SourcePriorities extends Component {
   constructor(props) {
     super(props)
     this.state = {
-      availablePaths: []
+      availablePaths: [],
+      sources: {}
     }
     fetchAvailablePaths((pathsArray) => {
       this.setState({
@@ -358,6 +369,30 @@ class SourcePriorities extends Component {
         }))
       })
     })
+    this.resolveSourceLabel = this.resolveSourceLabel.bind(this)
+  }
+
+  componentDidMount() {
+    this.fetchSources()
+    this.sourcesInterval = setInterval(() => this.fetchSources(), 30000)
+  }
+
+  componentWillUnmount() {
+    if (this.sourcesInterval) {
+      clearInterval(this.sourcesInterval)
+    }
+  }
+
+  fetchSources() {
+    fetchSourcesData()
+      .then((sources) => {
+        this.setState({ sources })
+      })
+      .catch(() => undefined)
+  }
+
+  resolveSourceLabel(sourceRef) {
+    return getSourceDisplayLabel(sourceRef, this.state.sources)
   }
 
   render() {
@@ -421,6 +456,7 @@ class SourcePriorities extends Component {
                         dispatch={this.props.dispatch}
                         isSaving={this.props.saveState.isSaving}
                         pathIndex={index}
+                        resolveSourceLabel={this.resolveSourceLabel}
                       />
                     </td>
                     <td style={{ border: 'none' }}>

From bb192b4cd997287e7a3778308458aecd937d2536 Mon Sep 17 00:00:00 2001
From: KE Gustafsson <ke.gustafsson@gmail.com>
Date: Sat, 21 Feb 2026 16:58:07 +0200
Subject: [PATCH 2/2] fix(ws): publish device descriptions in sources

Add ws source metadata publishing for approved/authorized devices so
admin UIs can resolve ws source refs to human-readable labels.

Cache device descriptions and skip duplicate source delta writes for
performance.

Extend security test to verify /signalk/v1/api/sources exposes ws device
description under n2k metadata after ws connect.
---
 src/interfaces/ws.js | 100 ++++++++++++++++++++++++++++++++++++++++---
 test/security.js     |  26 +++++++++++
 2 files changed, 120 insertions(+), 6 deletions(-)

diff --git a/src/interfaces/ws.js b/src/interfaces/ws.js
index 47992ccee..e625f00da 100644
--- a/src/interfaces/ws.js
+++ b/src/interfaces/ws.js
@@ -17,7 +17,11 @@ const _ = require('lodash')
 const ports = require('../ports')
 const cookie = require('cookie')
 const { getSourceId, getMetadata } = require('@signalk/signalk-schema')
-const { requestAccess, InvalidTokenError } = require('../security')
+const {
+  requestAccess,
+  InvalidTokenError,
+  getSecurityConfig
+} = require('../security')
 const {
   findRequest,
   updateRequest,
@@ -45,6 +49,84 @@ const BACKPRESSURE_EXIT_THRESHOLD = process.env.BACKPRESSURE_EXIT
   ? parseInt(process.env.BACKPRESSURE_EXIT, 10)
   : 1024
 
+function wsSourceRefFromIdentifier(identifier) {
+  return `ws.${identifier.replace(/\./g, '_')}`
+}
+
+const wsDeviceDescriptionCache = new Map()
+
+function getWsDeviceDescription(app, identifier) {
+  if (
+    !identifier ||
+    identifier === 'AUTO' ||
+    !app.securityStrategy ||
+    typeof app.securityStrategy.getDevices !== 'function'
+  ) {
+    return undefined
+  }
+
+  const cached = wsDeviceDescriptionCache.get(identifier)
+  if (cached !== undefined) {
+    return cached || undefined
+  }
+
+  try {
+    const config = getSecurityConfig(app)
+    const devices = app.securityStrategy.getDevices(config)
+    if (!Array.isArray(devices)) {
+      wsDeviceDescriptionCache.set(identifier, null)
+      return undefined
+    }
+    const device = devices.find((candidate) => candidate.clientId === identifier)
+    const description =
+      device && device.description ? device.description : undefined
+    wsDeviceDescriptionCache.set(identifier, description || null)
+    return description
+  } catch (error) {
+    debugConnection(
+      `could not resolve ws device description for ${identifier}: ${
+        error && error.message ? error.message : error
+      }`
+    )
+    wsDeviceDescriptionCache.set(identifier, null)
+    return undefined
+  }
+}
+
+function publishWsDeviceSourceMetadata(app, identifier) {
+  if (!app.deltaCache || typeof app.deltaCache.setSourceDelta !== 'function') {
+    return
+  }
+
+  const sourceRef = wsSourceRefFromIdentifier(identifier)
+  if (sourceRef in app.deltaCache.sourceDeltas) {
+    return
+  }
+
+  const description = getWsDeviceDescription(app, identifier)
+  if (!description) {
+    return
+  }
+
+  const sourceDelta = {
+    context: app.selfContext,
+    updates: [
+      {
+        source: {
+          label: 'ws',
+          src: sourceRef.substring(3),
+          type: 'ws',
+          description
+        },
+        timestamp: new Date().toISOString(),
+        values: []
+      }
+    ]
+  }
+
+  app.deltaCache.setSourceDelta(sourceRef, sourceDelta)
+}
+
 module.exports = function (app) {
   'use strict'
 
@@ -186,6 +268,7 @@ module.exports = function (app) {
         let principalId
         if (spark.request.skPrincipal) {
           principalId = spark.request.skPrincipal.identifier
+          publishWsDeviceSourceMetadata(app, principalId)
         }
 
         debugConnection(
@@ -288,7 +371,7 @@ module.exports = function (app) {
               }
 
               if (msg.accessRequest) {
-                processAccessRequest(spark, msg)
+                processAccessRequest(app, spark, msg)
               }
 
               if (msg.login && app.securityStrategy.supportsLogin()) {
@@ -438,7 +521,7 @@ module.exports = function (app) {
     })
   }
 
-  function processAccessRequest(spark, msg) {
+  function processAccessRequest(app, spark, msg) {
     if (spark.skPendingAccessRequest) {
       spark.write({
         requestId: msg.requestId,
@@ -461,8 +544,13 @@ module.exports = function (app) {
             if (res.accessRequest && res.accessRequest.token) {
               spark.request.token = res.accessRequest.token
               app.securityStrategy.authorizeWS(spark.request)
-              spark.request.source =
-                'ws.' + spark.request.skPrincipal.identifier.replace(/\./g, '_')
+              spark.request.source = wsSourceRefFromIdentifier(
+                spark.request.skPrincipal.identifier
+              )
+              publishWsDeviceSourceMetadata(
+                app,
+                spark.request.skPrincipal.identifier
+              )
             }
           }
           spark.write(res)
@@ -531,7 +619,7 @@ function createPrimusAuthorize(authorizeWS) {
       const identifier = _.get(req, 'skPrincipal.identifier')
       if (identifier) {
         debug(`authorized username: ${identifier}`)
-        req.source = 'ws.' + identifier.replace(/\./g, '_')
+        req.source = wsSourceRefFromIdentifier(identifier)
       }
     } catch (error) {
       // To be able to login or request access via WS with security in place
diff --git a/test/security.js b/test/security.js
index 391da01d1..5ad8e4534 100644
--- a/test/security.js
+++ b/test/security.js
@@ -506,6 +506,7 @@ describe('Security', () => {
     json.accessRequest.should.have.property('permission')
     json.accessRequest.permission.should.equal('APPROVED')
     json.accessRequest.should.have.property('token')
+    const deviceToken = json.accessRequest.token
 
     result = await fetch(`${url}/skServer/security/devices`, {
       headers: {
@@ -519,6 +520,31 @@ describe('Security', () => {
     json[0].clientId.should.equal('1235-45653-343453')
     json[0].permissions.should.equal('readwrite')
     json[0].description.should.equal('My Awesome Sensor')
+
+    await new Promise((resolve, reject) => {
+      const ws = new WebSocket(
+        `ws://0.0.0.0:${port}/signalk/v1/stream?subscribe=none&token=${deviceToken}`
+      )
+      ws.on('message', () => {
+        ws.close()
+      })
+      ws.on('close', resolve)
+      ws.on('error', reject)
+    })
+
+    result = await fetch(`${url}/signalk/v1/api/sources`, {
+      headers: {
+        Cookie: `JAUTHENTICATION=${adminToken}`
+      }
+    })
+    result.status.should.equal(200)
+    json = await result.json()
+    json.should.have.property('ws')
+    json.ws.should.have.property('1235-45653-343453')
+    json.ws['1235-45653-343453'].should.have.property('n2k')
+    json.ws['1235-45653-343453'].n2k.description.should.equal(
+      'My Awesome Sensor'
+    )
   })
 
   it('Device access request and denial works', async function () {
