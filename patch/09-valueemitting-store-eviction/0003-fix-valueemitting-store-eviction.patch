From 14a28034aaa7708c97474c197fbcd110c008531a Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sun, 22 Feb 2026 12:01:07 +0000
Subject: [PATCH] fix: evict stale AIS contexts from ValueEmittingStore to
 bound memory

ValueEmittingStore is a singleton that accumulates data for every
context seen in a session (vessels.self, plus every AIS target).
In a busy anchorage or port with hundreds of AIS targets, the store
grows without limit over a long session because it had no eviction.

Track the last-updated timestamp for each non-self context and
schedule a periodic sweep (every 5 minutes, matching the server-side
deltacache.ts purge interval) that removes contexts not updated within
that window. Eviction also cleans up the per-path listeners map so
there are no dangling callbacks.

If the user is browsing an evicted context it will briefly show
"waiting for data" until the next server delta repopulates it.

https://claude.ai/code/session_0142hccyF52oZwDAmLrntwTp
---
 .../views/DataBrowser/ValueEmittingStore.js   | 49 +++++++++++++++++++
 1 file changed, 49 insertions(+)

diff --git a/packages/server-admin-ui/src/views/DataBrowser/ValueEmittingStore.js b/packages/server-admin-ui/src/views/DataBrowser/ValueEmittingStore.js
index 426be40..795fc00 100644
--- a/packages/server-admin-ui/src/views/DataBrowser/ValueEmittingStore.js
+++ b/packages/server-admin-ui/src/views/DataBrowser/ValueEmittingStore.js
@@ -8,6 +8,10 @@
  * since the same path can have multiple values from different sources.
  */
 
+// Evict non-self contexts that have not received an update in this window.
+// Mirrors the server-side deltacache.ts AIS purge cycle.
+const CONTEXT_EVICTION_MAX_AGE_MS = 5 * 60 * 1000
+
 class ValueEmittingStore {
   constructor() {
     // Data storage: { context: { path$SourceKey: pathData } }
@@ -20,6 +24,39 @@ class ValueEmittingStore {
     this.structureListeners = new Set()
     // Version counter for structural changes
     this.version = 0
+    // Last-updated timestamps for non-self contexts (used for eviction)
+    this._contextLastUpdated = {}
+  }
+
+  /**
+   * Evict a single context - removes all stored data, meta, and listeners.
+   * Structure listeners are notified so the UI can update.
+   */
+  _evictContext(context) {
+    const paths = Object.keys(this.data[context] || {})
+    for (const path$SourceKey of paths) {
+      this.listeners.delete(`${context}:${path$SourceKey}`)
+    }
+    delete this.data[context]
+    delete this.meta[context]
+    delete this._contextLastUpdated[context]
+    this.version++
+    this.structureListeners.forEach((callback) => callback(this.version))
+  }
+
+  /**
+   * Evict non-self contexts that have not received an update within maxAgeMs.
+   * Called periodically by the singleton instance.
+   */
+  _evictStaleContexts(maxAgeMs) {
+    const now = Date.now()
+    for (const context of Object.keys(this.data)) {
+      if (context === 'self') continue
+      const lastUpdated = this._contextLastUpdated[context] || 0
+      if (now - lastUpdated > maxAgeMs) {
+        this._evictContext(context)
+      }
+    }
   }
 
   /**
@@ -30,6 +67,11 @@ class ValueEmittingStore {
       this.data[context] = {}
     }
 
+    // Track last-update time so _evictStaleContexts knows which contexts are live
+    if (context !== 'self') {
+      this._contextLastUpdated[context] = Date.now()
+    }
+
     const isNew = !this.data[context][path$SourceKey]
     this.data[context][path$SourceKey] = pathData
 
@@ -118,5 +160,12 @@ class ValueEmittingStore {
 // Singleton instance
 const store = new ValueEmittingStore()
 
+// Periodically remove stale non-self contexts to prevent unbounded memory growth
+// from AIS targets that are no longer transmitting.
+setInterval(
+  () => store._evictStaleContexts(CONTEXT_EVICTION_MAX_AGE_MS),
+  CONTEXT_EVICTION_MAX_AGE_MS
+)
+
 export default store
 export { ValueEmittingStore }
-- 
2.43.0

